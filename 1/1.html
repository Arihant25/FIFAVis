<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Cup Champion Performance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto 30px auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #1a365d;
            font-size: 2rem;
            margin-bottom: 2rem;
            position: relative;
            padding-bottom: 15px;
        }

        h2:after {
            content: '⚽';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
        }

        .bar {
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 1px;
            transition: opacity 0.3s ease;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .axis-label {
            font-size: 14px;
            font-weight: 600;
        }

        .tick text {
            font-size: 12px;
            font-weight: 500;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .toggle-label {
            font-size: 1rem;
            font-weight: 600;
            color: #1a365d;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 200px;
            height: 34px;
            background-color: #e2e8f0;
            border-radius: 17px;
            cursor: pointer;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            border-radius: 17px;
            background-color: #e2e8f0;
            transition: 0.4s;
        }

        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 26px;
            width: 95px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 13px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-option {
            color: #1a365d;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1;
            transition: color 0.4s;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(97px);
        }

        input:checked+.toggle-slider .toggle-option.year {
            color: #1a365d;
        }

        .mobile-warning {
            display: none;
            text-align: center;
            padding: 20px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 90%;
        }

        @media screen and (max-width: 1172px) {
            .container {
                display: none;
            }

            .mobile-warning {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>Men's World Cup Champions: Performance in the Next Tournament</h2>
        <div class="toggle-container">
            <span class="toggle-label">Group by</span>
            <label class="toggle-switch">
                <input type="checkbox" id="grouping-toggle-mens">
                <div class="toggle-slider">
                    <span class="toggle-option year">Year</span>
                    <span class="toggle-option country">Country</span>
                </div>
            </label>
        </div>
        <svg id="mens-chart" width="1100" height="600"></svg>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>Successfully Defended Title</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>Failed to Defend Title</span>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Women's World Cup Champions: Performance in the Next Tournament</h2>
        <div class="toggle-container">
            <span class="toggle-label">Group by</span>
            <label class="toggle-switch">
                <input type="checkbox" id="grouping-toggle-womens">
                <div class="toggle-slider">
                    <span class="toggle-option year">Year</span>
                    <span class="toggle-option country">Country</span>
                </div>
            </label>
        </div>
        <svg id="womens-chart" width="1100" height="600"></svg>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>Successfully Defended Title</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e67e22;"></div>
                <span>Failed to Defend Title</span>
            </div>
        </div>
    </div>

    <div class="mobile-warning">
        <h3>⚠️ Desktop View Recommended</h3>
        <p>This visualization is not optimized for small screens. Please view on a desktop or tablet device for the best
            experience.</p>
    </div>

    <script>
        function createChart(data, svgId, successColor, failColor, groupBy = 'year') {
            // Clear existing chart
            d3.select(svgId).selectAll("*").remove();

            // Set up dimensions
            const width = 1100, height = 500;
            const margin = { top: 20, right: 0, bottom: 150, left: 80 };
            const svg = d3.select(svgId)
                .attr("width", width)
                .attr("height", height);

            // Create tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Modified data processing to track consecutive wins
            // Modified data processing to track consecutive wins
            let processedData = [];
            if (groupBy === 'year') {
                processedData = data.flatMap(country => {
                    return country.years.map((year, i) => {
                        // Find if this country won the next tournament
                        let nextTournamentYear;
                        if (year === "1938") {
                            nextTournamentYear = "1950"; // Special case for WWII gap
                        } else {
                            nextTournamentYear = (parseInt(year) + 4).toString();
                        }

                        // Check if the same team won the next tournament
                        const wonNextTournament = country.years.includes(nextTournamentYear) &&
                            country.years[country.years.indexOf(year) + 1] === nextTournamentYear;

                        return {
                            team: country.team,
                            year: year,
                            goals: country.goals[i],
                            defended: wonNextTournament
                        };
                    });
                }).sort((a, b) => a.year.localeCompare(b.year));
            }
            else {
                // For country view
                processedData = data.map(country => ({
                    ...country,
                    defended: country.years.some((year, i) => {
                        if (i < country.years.length - 1) {
                            const currentYear = parseInt(year);
                            const nextYear = parseInt(country.years[i + 1]);
                            // Handle the special case for 1938-1950
                            if (currentYear === 1938 && nextYear === 1950) {
                                return true;
                            }
                            return nextYear - currentYear === 4;
                        }
                        return false;
                    })
                }));
            }

            // Create scales
            const xScale = d3.scaleBand()
                .domain(groupBy === 'year'
                    ? processedData.map(d => `${d.team} (${d.year})`)
                    : processedData.map(d => d.team))
                .range([margin.left, width - margin.right])
                .padding(0.3);

            const maxGoals = groupBy === 'year'
                ? d3.max(processedData, d => d.goals)
                : d3.max(processedData, d => d3.max(d.goals));

            const yScale = d3.scaleLinear()
                .domain([0, maxGoals])
                .nice()
                .range([height - margin.bottom, margin.top]);

            // Draw axes
            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "12px")
                .style("font-weight", "600");

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale)
                    .ticks(10)
                    .tickSize(-width + margin.left + margin.right))
                .call(g => g.select(".domain").remove())
                .call(g => g.selectAll(".tick line")
                    .attr("stroke", "#e0e0e0")
                    .attr("stroke-dasharray", "2,2"));

            // Draw bars with modified coloring logic
            if (groupBy === 'year') {
                // Single bars for year view
                svg.selectAll(".bar")
                    .data(processedData)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => xScale(`${d.team} (${d.year})`))
                    .attr("y", d => yScale(d.goals))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => height - margin.bottom - yScale(d.goals))
                    .attr("fill", d => d.defended ? successColor : failColor)
                    .attr("rx", 4)
                    .on("mouseover", function (event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        const defenseStatus = d.defended ? "Successfully defended in next World Cup" : "Did not defend in next World Cup";
                        tooltip.html(`${d.team}<br/>Goals in ${d.year}: ${d.goals}<br/>${defenseStatus}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function () {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            } else {
                // Multiple bars per country for country view
                processedData.forEach(country => {
                    const barWidth = xScale.bandwidth() / country.goals.length;

                    country.years.forEach((year, i) => {
                        const nextTournamentYear = year === "1938" ? "1950" : (parseInt(year) + 4).toString();
                        const wonNextTournament = i < country.years.length - 1 &&
                            country.years[i + 1] === nextTournamentYear;

                        svg.append("rect")
                            .attr("class", "bar")
                            .attr("x", xScale(country.team) + (i * barWidth))
                            .attr("y", yScale(country.goals[i]))
                            .attr("width", barWidth - 2)
                            .attr("height", height - margin.bottom - yScale(country.goals[i]))
                            .attr("fill", wonNextTournament ? successColor : failColor)
                            .attr("rx", 4)
                            .on("mouseover", function (event) {
                                tooltip.transition()
                                    .duration(200)
                                    .style("opacity", .9);
                                const defenseStatus = wonNextTournament ? "Successfully defended in next World Cup" : "Did not defend in next World Cup";
                                tooltip.html(`${country.team}<br/>Goals in ${year}: ${country.goals[i]}<br/>${defenseStatus}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            })
                            .on("mouseout", function () {
                                tooltip.transition()
                                    .duration(500)
                                    .style("opacity", 0);
                            });
                    });
                });
            }

            // Add axis labels
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - 10)
                .attr("text-anchor", "middle")
                .attr("class", "axis-label")
                .text("World Cup Champions");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", 25)
                .attr("text-anchor", "middle")
                .attr("class", "axis-label")
                .text("Total Goals Scored");
        }

        // Load both datasets
        Promise.all([
            d3.csv("https://raw.githubusercontent.com/jfjelstul/worldcup/master/data-csv/tournament_standings.csv"),
            d3.csv("https://raw.githubusercontent.com/jfjelstul/worldcup/master/data-csv/goals.csv")
        ]).then(([tournamentData, goalsData]) => {
            // Process goals data for men's and women's tournaments
            const mensGoalCounts = {};
            const womensGoalCounts = {};

            goalsData.forEach(d => {
                const isWomens = d.tournament_name && d.tournament_name.toLowerCase().includes('women');
                const counts = isWomens ? womensGoalCounts : mensGoalCounts;
                const key = d.team_name + '-' + d.tournament_id;
                counts[key] = (counts[key] || 0) + 1;
            });

            // Process tournament data to get winners
            const mensWinners = {};
            const womensWinners = {};

            tournamentData.forEach(d => {
                const isWomens = d.tournament_name && d.tournament_name.toLowerCase().includes('women');
                const winners = isWomens ? womensWinners : mensWinners;
                if (d.position === "1") {
                    winners[d.tournament_id] = d.team_name;
                }
            });

            // Create chart data for both tournaments
            function createChartData(winners, goalCounts) {
                const tournamentYears = Object.keys(winners).sort();
                const countryData = {};

                tournamentYears.forEach(year => {
                    const team = winners[year];
                    if (!countryData[team]) {
                        countryData[team] = {
                            years: [],
                            goals: []
                        };
                    }
                    countryData[team].years.push(year.replace('WC-', ''));
                    countryData[team].goals.push(goalCounts[`${team}-${year}`] || 0);
                });

                return Object.entries(countryData).map(([team, data]) => ({
                    team,
                    years: data.years,
                    goals: data.goals,
                    defended: data.years.some((year, i) => {
                        if (i < data.years.length - 1) {
                            const currentYear = parseInt(year);
                            const nextYear = parseInt(data.years[i + 1]);
                            if (currentYear === 1938 && nextYear === 1950) return true;
                            return nextYear - currentYear === 4;
                        }
                        return false;
                    })
                }));
            }

            // Create both charts
            const mensChartData = createChartData(mensWinners, mensGoalCounts);
            const womensChartData = createChartData(womensWinners, womensGoalCounts);

            // Initial chart creation
            createChart(mensChartData, "#mens-chart", "#2ecc71", "#e74c3c", 'year');
            createChart(womensChartData, "#womens-chart", "#9b59b6", "#e67e22", 'year');

            // Add toggle event listeners
            document.getElementById('grouping-toggle-mens').addEventListener('change', function (e) {
                createChart(mensChartData, "#mens-chart", "#2ecc71", "#e74c3c", e.target.checked ? 'country' : 'year');
            });

            document.getElementById('grouping-toggle-womens').addEventListener('change', function (e) {
                createChart(womensChartData, "#womens-chart", "#9b59b6", "#e67e22", e.target.checked ? 'country' : 'year');
            });

        }).catch(error => console.error(error));
    </script>
</body>

</html>